<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrição - Curso LIBRAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Open Sans', sans-serif; background-color: #f8f8f8; color: #333333; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .form-radio { margin-right: 0.5rem; }
    </style>
</head>
<body class="flex justify-center items-center min-h-screen p-4 bg-gray-50">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg border border-gray-200">
        <h2 class="text-3xl font-light mb-2 text-gray-700 text-center">Curso de Libras - Inscrição</h2>
        <p class="text-gray-500 mb-8 text-center text-sm">Preencha seus dados. Todos os campos são obrigatórios.</p>
        
        <form id="form-cadastro" class="space-y-4">
            
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Nome Completo</label>
                <input type="text" id="nome_completo" class="input-field" required>
            </div>
            
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">E-mail</label>
                <input type="email" id="email_aluno" class="input-field" required>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Telefone (WhatsApp)</label>
                <input type="text" id="telefone" class="input-field" placeholder="(00) 99999-9999" required>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Congregação</label>
                <input type="text" id="congregacao" class="input-field" required>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Você é maior de 18 anos?</label>
                <div class="flex items-center space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="idade" value="sim" id="idade_sim" class="form-radio" required checked>
                        <span class="ml-2 text-gray-600">Sim</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="idade" value="nao" id="idade_nao" class="form-radio" required>
                        <span class="ml-2 text-gray-600">Não (Menor de idade)</span>
                    </label>
                </div>
            </div>

            <div id="responsavel-box" class="hidden mt-4 pt-4 border-t border-gray-100">
                <label class="block text-sm font-bold text-gray-700 mb-1">Nome completo do Responsável inscrito no curso.</label>
                <input type="text" id="nome_responsavel" class="input-field"> 
                <p class="text-xs text-gray-500 mt-1">NOTA: O responsável pelo menor deve estar inscrito no curso.</p>
            </div>

            <div id="responsavel-inscrito-box" class="hidden mt-4 pt-4 border-t border-gray-100">
                <label class="block text-sm font-bold text-gray-700 mb-1">O responsável está inscrito no curso?</label>
                <div class="flex items-center space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="responsavel_inscrito" value="sim" id="resp_sim" class="form-radio">
                        <span class="ml-2 text-gray-600">Sim</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="responsavel_inscrito" value="nao" id="resp_nao" class="form-radio">
                        <span class="ml-2 text-gray-600">Não</span>
                    </label>
                </div>
            </div>
            
            <button type="submit" id="btn-enviar-cadastro" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 transition mt-6">
                ENVIAR INSCRIÇÃO
            </button>
            <p id="feedback-msg" class="mt-4 text-sm font-semibold text-center"></p>
        </form>
        <div class="text-center mt-4">
            <a href="index.html" class="text-sm text-blue-600 hover:underline">Voltar para o Login</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        /* ======================
           CONFIG FIREBASE (USE A SUA CHAVE FINAL)
        ======================*/
        const firebaseConfig = {
            // SUBSTITUA PELA SUA CHAVE DE API FINAL E RESTRITA
            apiKey: "AIzaSyCvWBG_dk-3puP04otTBk8TY68-evcEnOQ", 
            authDomain: "curso-libras-lsroo.firebaseapp.com",
            projectId: "curso-libras-lsroo",
            // Os demais campos são opcionais aqui, mas podem ser incluídos para consistência
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* ======================
           CONFIGURAÇÕES E ELEMENTOS
        ======================*/
        const REGISTROS_REF = collection(db, "inscricoes_alunos");
        const LIMITE_TURMA_1 = 20;
        const LIMITE_TOTAL = 40; 
        const form = document.getElementById('form-cadastro');
        const feedbackMsg = document.getElementById('feedback-msg');
        
        // Elementos dos campos de Responsável
        const responsavelBox = document.getElementById('responsavel-box');
        const nomeResponsavelInput = document.getElementById('nome_responsavel');
        const responsavelInscritoBox = document.getElementById('responsavel-inscrito-box');


        /* ======================
           LÓGICA VISUAL E OBRIGATORIEDADE
        ======================*/
        function handleMinorAge() {
            const isMinor = document.getElementById('idade_nao').checked;
            
            // Controle da caixa de Nome do Responsável
            if (isMinor) {
                responsavelBox.classList.remove('hidden');
                nomeResponsavelInput.required = true;
                
                // Controle da caixa de Responsável Inscrito
                responsavelInscritoBox.classList.remove('hidden');
                document.getElementById('resp_sim').required = true; // Torna o grupo obrigatório
            } else {
                // Se for maior, esconde e remove obrigatoriedade
                responsavelBox.classList.add('hidden');
                nomeResponsavelInput.required = false;
                nomeResponsavelInput.value = '';
                
                responsavelInscritoBox.classList.add('hidden');
                document.getElementById('resp_sim').required = false;
            }
        }

        // Adiciona listeners para garantir que a lógica seja aplicada ao mudar o rádio
        document.getElementById('idade_nao').addEventListener('change', handleMinorAge);
        document.getElementById('idade_sim').addEventListener('change', handleMinorAge);


        /* ======================
           LÓGICA DE CADASTRO E LIMITE
        ======================*/
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validação final de campos vazios pelo HTML (required)
            if (!form.checkValidity()) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            feedbackMsg.classList.remove('text-green-600', 'text-red-600', 'text-orange-600');
            feedbackMsg.textContent = 'Processando inscrição...';

            // 1. Coleta dos Dados
            const nome = nomeResponsavelInput.value;
            const email = document.getElementById('email_aluno').value;
            const telefone = document.getElementById('telefone').value;
            const congregacao = document.getElementById('congregacao').value;
            const maiorIdade = document.querySelector('input[name="idade"]:checked').value === 'sim';
            
            let nomeResponsavel = null;
            let responsavelInscrito = null;

            if (!maiorIdade) {
                 nomeResponsavel = nomeResponsavelInput.value;
                 responsavelInscrito = document.querySelector('input[name="responsavel_inscrito"]:checked').value === 'sim';
            }


            // 2. Lógica de Contagem e Turma
            try {
                // Checa se o email já existe (para evitar duplicação)
                const snapshotDocs = await getDocs(REGISTROS_REF);
                const emailsExistentes = snapshotDocs.docs.map(doc => doc.data().email.toLowerCase());
                
                if (emailsExistentes.includes(email.toLowerCase())) {
                    feedbackMsg.textContent = 'Este e-mail já está cadastrado. Por favor, use a opção de Login.';
                    feedbackMsg.classList.add('text-red-600');
                    return;
                }

                const totalInscritos = snapshotDocs.size;
                let turma_designada = '';
                let mensagem = '';
                let msg_cor = 'text-green-600';

                if (totalInscritos < LIMITE_TURMA_1) {
                    turma_designada = 'Turma 1';
                    mensagem = 'Inscrição confirmada! Você está na Turma 1.';
                } 
                else if (totalInscritos < LIMITE_TOTAL) {
                    turma_designada = 'Lista de Espera / Turma 2';
                    mensagem = 'Agradecemos seu interesse, mas no momento, as vagas da Turma 1 estão esgotadas. Você foi adicionado à Lista de Espera/Turma 2.';
                    msg_cor = 'text-orange-600';
                } 
                else {
                    feedbackMsg.textContent = 'Agradecemos seu intersse, mas no momento as vagas foram encerradas. (Limite de 40 alunos atingido).';
                    feedbackMsg.classList.add('text-red-600');
                    return; 
                }

                // 3. Registro no Firestore
                await setDoc(doc(REGISTROS_REF), {
                    nome: nome,
                    email: email,
                    telefone: telefone,
                    congregacao: congregacao,
                    maior_idade: maiorIdade,
                    nome_responsavel: nomeResponsavel,
                    responsavel_inscrito: responsavelInscrito,
                    turma: turma_designada,
                    timestamp: new Date()
                });
                
                // Sucesso
                feedbackMsg.textContent = mensagem;
                feedbackMsg.classList.add(msg_cor);
                form.reset(); // Limpa o formulário

            } catch (e) {
                console.error("Erro ao registrar no Firestore:", e);
                feedbackMsg.textContent = 'Erro grave ao processar a inscrição. Tente novamente.';
                feedbackMsg.classList.add('text-red-600');
            }
        });
    </script>
</body>

</html>
